- id: lma-check-env-configuartion
  type: puppet
  version: 2.0.0
  cross-depended-by:
    - name: deploy_start
  parameters:
    puppet_manifest: puppet/manifests/check_environment_configuration.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 300


# The Hiera data needs to be populated first so that other plugins (eg LMA
# Infrastructure Alerting) can use it
- id: lma-stage1-hiera-override
  type: puppet
  version: 2.0.0
  parameters:
    puppet_manifest: puppet/manifests/hiera_override.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 600

- id: lma-stage1-configure-apt
  type: puppet
  version: 2.0.0
  parameters:
    puppet_manifest: puppet/manifests/configure_apt.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 600

- id: lma-base
  type: puppet
  version: 2.0.0
  cross-depends:
    - name: /lma-stage1/
  parameters:
    puppet_manifest: puppet/manifests/base.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 600

- id: lma-aggregator
  type: puppet
  version: 2.0.0
  cross-depends:
    - name: /lma-stage1/
  parameters:
    puppet_manifest: puppet/manifests/aggregator.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 600


- id: lma-controller
  type: puppet
  version: 2.0.0
  groups: ['controller', 'primary-controller']
  cross-depends:
    - name: /lma-stage1/
  parameters:
    puppet_manifest: puppet/manifests/controller.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 600

- id: lma-compute
  type: puppet
  version: 2.0.0
  groups: [ 'compute' ]
  cross-depends:
    - name: /lma-stage1/
  parameters:
    puppet_manifest: puppet/manifests/compute.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 600

- id: lma-cinder
  type: puppet
  version: 2.0.0
  groups: ['cinder']
  cross-depends:
    - name: /lma-stage1/
  parameters:
    puppet_manifest: puppet/manifests/cinder.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 600

- id: lma-ceph-osd
  type: puppet
  version: 2.0.0
  groups: ['ceph-osd']
  cross-depends:
    - name: /lma-stage1/
  parameters:
    puppet_manifest: puppet/manifests/ceph_osd.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 600

- id: lma-configure-afd-filters
  type: puppet
  version: 2.0.0
  cross-depends:
    - name: /lma-stage1/
  parameters:
    puppet_manifest: puppet/manifests/configure_afd_filters.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 600

- id: lma-backends
  type: puppet
  version: 2.0.0
  groups:
    - primary-elasticsearch_kibana
    - elasticsearch_kibana
    - primary-influxdb_grafana
    - influxdb_grafana
  cross-depends:
    - name: /lma-stage1/
  parameters:
    puppet_manifest: puppet/manifests/lma_backends.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 600

# We prefix "lma" with "last" because we want to add a dependency with
# all other lma tasks. This one must be done at the end.
- id: last-lma-cleanup-apt-config
  type: puppet
  cross-depends:
      - name: /^lma/
  parameters:
    puppet_manifest: puppet/manifests/cleanup_apt_config.pp
    puppet_modules: puppet/modules:/etc/puppet/modules
    timeout: 600

