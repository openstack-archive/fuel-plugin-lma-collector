---
lma_collector:

  gse_severity_policies:
    # When the cluster's status depends on the member with the highest severity,
    # typically used for service clusters.
    - highest_severity_policy:
        - severity: down
          trigger:
            logical_operator: or
            rules:
              - metric: down
                relational_operator: '>'
                threshold: 0
        - severity: critical
          trigger:
            logical_operator: or
            rules:
              - metric: critical
                relational_operator: '>'
                threshold: 0
        - severity: warning
          trigger:
            logical_operator: or
            rules:
              - metric: warning
                relational_operator: '>'
                threshold: 0
        - severity: okay
          trigger:
            logical_operator: or
            rules:
              - metric: okay
                relational_operator: '>'
                threshold: 0
        - severity: unknown
          trigger:
            logical_operator: or
            rules:
              - metric: unknown
                relational_operator: '>'
                threshold: 0

    # When the cluster's status depends on the status of its quorum, typically
    # used for clusters of controller nodes.
    - quorum_policy:
        - severity: down
          trigger:
            logical_operator: or
            rules:
              - metric: down
                relational_operator: '>'
                threshold: 0.5
        - severity: down
          trigger:
            logical_operator: and
            rules:
              - metric: down
                relational_operator: '>'
                threshold: 0
              - metric: critical
                relational_operator: '>'
                threshold: 0.5
        - severity: critical
          trigger:
            logical_operator: or
            rules:
              - metric: critical
                relational_operator: '>'
                threshold: 0.5
                function: sum
        - severity: critical
          trigger:
            logical_operator: and
            rules:
              - metric: critical
                relational_operator: '>'
                threshold: 0
              - metric: warning
                relational_operator: '>'
                threshold: 0.5
        - severity: warning
          trigger:
            logical_operator: or
            rules:
              - metric: warning
                relational_operator: '>'
                threshold: 0.5
        - severity: okay
          trigger:
            logical_operator: or
            rules:
              - metric: okay
                relational_operator: '>'
                threshold: 0.5
        - severity: unknown
          trigger:
            logical_operator: or
            rules:
              - metric: unknown
                relational_operator: '>'
                threshold: 0.5

  gse_cluster_service:
    input_message_types:
      - afd_service_metric
    aggregator_flag: true
    # the field in the input messages to identify the cluster
    cluster_field: service
    # the field in the input messages to identify the cluster's member
    member_field: source
    output_message_type: gse_service_cluster_metric
    output_metric_name: cluster_service_status
    interval: 10
    warm_up_period: 20
    clusters:
      mysqld-tcp:
        policy: highest_severity_policy
        members:
          - backends
      mysql:
        policy: quorum_policy
        group_by_hostname: true
        members:
          - heartbeat
      haproxy:
        policy: quorum_policy
        group_by_hostname: true
        members:
          - heartbeat
      apache:
        policy: quorum_policy
        group_by_hostname: true
        members:
          - heartbeat
      memcached:
        policy: quorum_policy
        group_by_hostname: true
        members:
          - heartbeat
      rabbitmq:
        policy: quorum_policy
        group_by_hostname: true
        members:
          - heartbeat
          - memory
          - disk
          - queue
      nova-api:
        policy: highest_severity_policy
        members:
          - backends
          - endpoint
      nova-ec2-api:
        policy: highest_severity_policy
        members:
          - backends
      nova-novncproxy-websocket:
        policy: highest_severity_policy
        members:
          - backends
      nova-metadata-api:
        policy: highest_severity_policy
        members:
          - backends
      nova-scheduler:
        policy: highest_severity_policy
        members:
          - workers
      nova-cert:
        policy: highest_severity_policy
        members:
          - workers
      nova-consoleauth:
        policy: highest_severity_policy
        members:
          - workers
      nova-compute:
        policy: highest_severity_policy
        members:
          - workers
      nova-conductor:
        policy: highest_severity_policy
        members:
          - workers
      cinder-api:
        policy: highest_severity_policy
        members:
          - backends
          - endpoint
      cinder-v2-api:
        policy: highest_severity_policy
        members:
          # Cinder V2 backends are in fact the same as the Cinder backends
          - endpoint
      cinder-scheduler:
        policy: highest_severity_policy
        members:
          - workers
      cinder-volume:
        policy: highest_severity_policy
        members:
          - workers
      neutron-api:
        policy: highest_severity_policy
        members:
          - backends
          - endpoint
      neutron-l3:
        policy: highest_severity_policy
        members:
          - workers
      neutron-dhcp:
        policy: highest_severity_policy
        members:
          - workers
      neutron-metadata:
        policy: highest_severity_policy
        members:
          - workers
      neutron-openvswitch:
        policy: highest_severity_policy
        members:
          - workers
      keystone-public-api:
        policy: highest_severity_policy
        members:
          - backends
          - endpoint
      keystone-admin-api:
        policy: highest_severity_policy
        members:
          # TODO(pasquier-s): add a metric reporting the status of the keystone-admin-api endpoint
          - backends
      glance-api:
        policy: highest_severity_policy
        members:
          - backends
          - endpoint
      glance-registry-api:
        policy: highest_severity_policy
        members:
          - backends
      heat-api:
        policy: highest_severity_policy
        members:
          - backends
          - endpoint
      heat-cfn-api:
        policy: highest_severity_policy
        members:
          - backends
          - endpoint
      heat-cloudwatch-api:
        policy: highest_severity_policy
        members:
          - backends
<% if @tls_enabled then -%>
      horizon-https:
        policy: highest_severity_policy
        members:
          - backends
<% else -%>
      horizon-ui:
        policy: highest_severity_policy
        members:
          - backends
<% end -%>
<% if not @storage_options["objects_ceph"] then -%>
      swift-api:
        policy: highest_severity_policy
        members:
          - backends
          - endpoint
      swift-s3-api:
        policy: highest_severity_policy
        members:
          # Swift S3 backends are in fact the same as the Swift backends
          - endpoint
<% end -%>
<% if @ceilometer_enabled -%>
      ceilometer-api:
        policy: highest_severity_policy
        members:
          - backends
          - endpoint
<% end -%>

  gse_cluster_node:
    input_message_types:
      - afd_node_metric
    aggregator_flag: true
    # the field in the input messages to identify the cluster
    cluster_field: node_role
    # the field in the input messages to identify the cluster's member
    member_field: source
    output_message_type: gse_node_cluster_metric
    output_metric_name: cluster_node_status
    interval: 10
    warm_up_period: 80
    clusters:
      controller:
        policy: quorum_policy
        group_by_hostname: true
        members:
          - cpu
          - fs
      compute:
        policy: quorum_policy
        group_by_hostname: true
        members:
          - cpu
          - fs
      storage:
        policy: quorum_policy
        group_by_hostname: true
        members:
          - cpu
          - fs

  gse_cluster_global:
    input_message_types:
      - gse_service_cluster_metric
      - gse_node_cluster_metric
    aggregator_flag: false
    # the field in the input messages to identify the cluster's member
    member_field: cluster_name
    output_message_type: gse_cluster_metric
    output_metric_name: cluster_status
    interval: 10
    warm_up_period: 30
    clusters:
      mysql:
        policy: highest_severity_policy
        members:
          - mysqld-tcp
          - mysqld
          - controller
      haproxy:
        policy: highest_severity_policy
        members:
          - haproxy
          - controller
      apache:
        policy: highest_severity_policy
        members:
          - apache
          - controller
      memcached:
        policy: highest_severity_policy
        members:
          - memcached
          - controller
      rabbitmq:
        policy: highest_severity_policy
        members:
          - rabbitmq
          - controller
      nova:
        policy: highest_severity_policy
        members:
          - nova-api
          - nova-ec2-api
          - nova-metadata-api
          - nova-scheduler
          - nova-compute
          - nova-conductor
          - nova-cert
          - nova-consoleauth
          - nova-novncproxy-websocket
          - controller
          - compute
        hints:
          - cinder
          - glance
          - keystone
          - neutron
      cinder:
        policy: highest_severity_policy
        members:
          - cinder-api
          - cinder-v2-api
          - cinder-scheduler
          - cinder-volume
          - controller
          - storage
        hints:
          - keystone
      neutron:
        policy: highest_severity_policy
        members:
          - neutron-api
          - neutron-l3
          - neutron-dhcp
          - neutron-metadata
          - neutron-openvswitch
          - controller
        hints:
          - keystone
      keystone:
        policy: highest_severity_policy
        members:
          - keystone-public-api
          - keystone-admin-api
          - controller
        hints: []
      glance:
        policy: highest_severity_policy
        members:
          - glance-api
          - glance-registry-api
          - controller
        hints:
          - keystone
      heat:
        policy: highest_severity_policy
        members:
          - heat-api
          - heat-cfn-api
          - heat-cloudwatch-api
          - controller
        hints:
          - cinder
          - glance
          - keystone
          - neutron
          - nova
      horizon:
        policy: highest_severity_policy
        members:
<% if @tls_enabled then -%>
          - horizon-https
<% else -%>
          - horizon-ui
<% end -%>
          - controller
        hints:
          - keystone
<% if not @storage_options["objects_ceph"] then -%>
      swift:
        policy: highest_severity_policy
        members:
          - swift-api
          - swift-s3-api
          - controller
        hints:
          - keystone
<% end -%>
<% if @ceilometer_enabled -%>
      ceilometer:
        policy: highest_severity_policy
        members:
          - ceilometer-api
          - controller
        hints:
          - keystone
<% end -%>
