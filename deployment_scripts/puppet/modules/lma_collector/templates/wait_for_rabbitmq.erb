#!/usr/bin/env python

from kombu import Connection
from kombu import Exchange
from kombu import Queue

def errback(exc, interval):
    print("Rabbitmq: {}, retry in {} seconds").format(exc, interval)

# First we need to check the connection
with Connection('amqp://<%= @rabbitmq_user %>:<%= @rabbitmq_password%>@localhost:<%= @rabbitmq_port %>//') as conn:

    conn.ensure_connection(errback, interval_start=<%= @wait_delay %>, interval_step=0)

    # Now we need to check that we can post a message
    PAYLOAD="CheckRabbitAvailability"
    QUEUE_NAME=PAYLOAD

    with conn.SimpleQueue(QUEUE_NAME) as queue:
        while True:
            try:
                queue.put(PAYLOAD)
                message = queue.get(timeout=<%= @wait_delay %>)
                message.ack()
                if message.payload != PAYLOAD:
                    print("Payload is not matching")
                else:
                    print("Connection established")
                    break
            except socket.timeout:
                # retry
                print("Cannot post a message on a queue ... retry")
            else:
                break

    # Finally, delete the queue and the exchange
    current_channel = conn.channel()

    bound_queue = Queue(PAYLOAD, channel=current_channel)
    bound_queue.delete()

    bound_exchange = Exchange(PAYLOAD, channel=current_channel)
    bound_exchange.delete()
