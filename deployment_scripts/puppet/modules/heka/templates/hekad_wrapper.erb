#!/bin/sh

HEKAD="/usr/bin/hekad"
RABBITMQCTL=$(which rabbitmqctl 2>/dev/null)

# We must wait that rabbitmq is started before running.
# We can not rely on /var/run/rabbitmq/p_pid because it only means that
# beam is running. If there is no command rabbitmqctl, just skip the
# waiting loop.

if [ ! -z $RABBITMQCTL ]; then
    while ! $RABBITMQCTL cluster_status >/dev/null 2>&1
    do
        echo "$(date +"%Y/%m/%d %H:%M:%S") Waiting for RabbitMQ availability..."
        sleep <%= @wait_for_rabbitmq %>
    done
fi

<%= @run_as_root ? "" : "sudo -u #{ @heka_user }" %> $HEKAD -config=<%= @config_dir %> 2>><%= @log_file %>
